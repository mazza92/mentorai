const puppeteerCaptionFetcher = require('./services/puppeteerCaptionFetcher');

async function testPuppeteer() {
  console.log('='.repeat(60));
  console.log('Testing Puppeteer Caption Fetcher');
  console.log('='.repeat(60));
  console.log();

  // Test with popular videos that definitely have captions
  const testVideoIds = [
    'NY3y0V9UDwM', // One of your test videos
    'dQw4w9WgXcQ', // Rick Roll
  ];

  console.log(`Testing ${testVideoIds.length} videos...\n`);

  for (const videoId of testVideoIds) {
    console.log(`\n${'='.repeat(60)}`);
    console.log(`Testing: https://youtube.com/watch?v=${videoId}`);
    console.log('='.repeat(60));

    try {
      const result = await puppeteerCaptionFetcher.fetchCaptions(videoId);

      if (result.success) {
        console.log(`\n✅ SUCCESS!`);
        console.log(`   Segments: ${result.segmentCount}`);
        console.log(`   Characters: ${result.charCount}`);
        console.log(`   Language: ${result.language}`);
        console.log(`   Auto-generated: ${result.isAutoGenerated}`);
        console.log(`\n   First 300 chars: "${result.text.substring(0, 300)}..."`);
      } else {
        console.log(`\n❌ FAILED: ${result.error}`);
      }
    } catch (error) {
      console.log(`\n❌ ERROR: ${error.message}`);
      console.error(error.stack);
    }
  }

  console.log(`\n\n${'='.repeat(60)}`);
  console.log('Batch Test (Multiple Concurrent)');
  console.log('='.repeat(60));

  try {
    const batchResults = await puppeteerCaptionFetcher.fetchMultiple(testVideoIds, 2);
    const successful = batchResults.filter(r => r.success).length;

    console.log(`\n✅ Batch complete: ${successful}/${testVideoIds.length} successful`);

    batchResults.forEach((result, index) => {
      const videoId = testVideoIds[index];
      if (result.success) {
        console.log(`   ✓ ${videoId}: ${result.segmentCount} segments`);
      } else {
        console.log(`   ✗ ${videoId}: ${result.error}`);
      }
    });

  } catch (error) {
    console.error(`\n❌ Batch test error: ${error.message}`);
  }

  // Cleanup
  console.log('\nClosing browser...');
  await puppeteerCaptionFetcher.close();
  console.log('✓ Browser closed');

  console.log('\n' + '='.repeat(60));
  console.log('Test Complete!');
  console.log('='.repeat(60));
}

testPuppeteer()
  .then(() => process.exit(0))
  .catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
  });
